
<section class="admin pb-5">
  <div class="container">
    <div class="row pt-3">
      <div class="col-md-7">
        <!-- Display admin's restaurants for selection -->
        <div class="col-12 pinkColor p-3 mt-3 margin-small-sc">
          <h4 class="smallH4 text-white">Your Poultry Batches</h4>
          <!-- Loader -->
          <div *ngIf="loader" class="text-center my-3">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-white">Fetching batches...</p>
          </div>

          <!-- Error -->
          <div *ngIf="batchErrorMessage && !loader" class="alert alert-danger text-center">
            {{ batchErrorMessage }}
          </div>
          <ul *ngIf="!loader && batches.length > 0" class="list-group">
            <div class="row">
              <div *ngIf="batchErrorMessage" class="alert alert-danger text-center">{{batchErrorMessage}}</div>
              <li 
                *ngFor="let batch of batches"
                class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start borderListing shadow mb-3"
              >
                <div class="col-md-9">
                  <strong class="smallText d-block">
                    {{ batch.name }} 
                    <span *ngIf="batch.status === 'Completed'" class="badge bg-danger ms-2">Ended</span>
                    <span *ngIf="batch.status === 'Active'" class="badge bg-success ms-2">Active</span>
                  </strong><br>
                  <small class="smallText"><strong>userId:</strong><span class="text-primary"> {{ batch.userId }}</span></small><br>
                  <small class="smallText"><strong>Batch Id:</strong><span class="text-primary"> {{ batch._id }}</span></small><br>
                  <small class="smallText"><strong>Batch Info:</strong><span class="text-primary"> {{ batch.description }}</span></small><br>
                  <small class="smallText">
                    <strong>startDate:</strong>
                    <span class="text-primary"> {{ batch.startDate | date: "longDate" }}</span>
                  </small><br/>

                  <!-- ✅ End Date only shows if batch is completed -->
                  <ng-container *ngIf="batch.status === 'Completed'">
                    <small class="smallText">
                      <strong>End Date:</strong>
                      <span class="text-danger"> {{ batch.endDate | date:'dd/MM/yyyy, HH:mm:ss' }}</span>
                    </small><br/>
                  </ng-container>

                  <small class="smallText">
                    <strong>createAt:</strong>
                    <span class="text-primary"> {{ batch.createAt | date:'dd/MM/yyyy, HH:mm:ss' }}</span>
                  </small><br/><br/>

                  <button
                    *ngIf="batch.status !== 'Completed'"
                    class="btn btn-sm btn-warning smallText button-size"
                    nz-popconfirm
                    nzPopconfirmTitle="Are you sure you want to end this batch? This action cannot be undone."
                    (nzOnConfirm)="endBatch(batch)"
                    nzPopconfirmPlacement="top"
                    nz-button
                  >End Batch!
                </button>
                </div>

                <!-- ✅ Buttons: inline on desktop, stacked at bottom on mobile -->
                <div class="mt-3 mt-md-0 d-flex justify-content-md-end w-100 gap-2">
                  <button class="btn btn-sm btn-primary smallText flex-fill flex-md-grow-0 button-size" (click)="selectBatch(batch)">
                    Select
                  </button>
                  <button
                   class="btn btn-sm btn-danger
                   smallText flex-fill flex-md-grow-0 button-size"
                   nz-popconfirm
                   nzPopconfirmTitle="Are you sure you want to delete this batch?"
                   (nzOnConfirm)="confirm(batch._id)"
                   (nzOnCancel)="cancel()"
                   nzPopconfirmPlacement="top"
                   nz-button
                  >
                    Delete
                  </button>
                </div>
              </li>

            </div>
          </ul>
          <div>
            <span class="text-white">{{ currentDate | date: "medium" }}</span>
          </div>
        </div>
      </div>
      <div class="col-md-5 padding-form">
        <form #form="ngForm" (ngSubmit)="submitForm(form)" class="needs-validation">
          <div *ngIf="successMessage" class="alert alert-success text-center">
            {{ successMessage }}
          </div>

          <div *ngIf="errorMessage" class="alert alert-danger text-center">
            {{ errorMessage }}
          </div>
          <div class="mb-3">
            <label class="form-label">Batch Name</label>
            <input
              type="text"
              class="form-control"
              name="name"
              [(ngModel)]="batchInput.name"
              #name="ngModel"
              [ngClass]="{'is-invalid': name.invalid && name.touched, 'is-valid': name.valid}"
              required
            />
            <div *ngIf="name.invalid && name.touched" class="invalid-feedback">Batch name is required to create a batch</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <input
              type="text"
              class="form-control"
              name="description"
              [(ngModel)]="batchInput.description"
              #description="ngModel"
              [ngClass]="{'is-invalid': description.invalid && description.touched, 'is-valid': description.valid}"
              required
            />
            <div *ngIf="description.invalid && description.touched" class="invalid-feedback">Describe your poultry batch</div>
          </div>

          <div class="mb-3">
            <label class="form-label">User ID</label>
            <input
              type="text"
              class="form-control"
              name="userId"
              [(ngModel)]="batchInput.userId"
              #userId="ngModel"
              [ngClass]="{'is-invalid': userId.invalid && userId.touched, 'is-valid': userId.valid}"
              readonly
            />
            <div *ngIf="userId.invalid && userId.touched" class="invalid-feedback">userId is auto provided</div>
          </div>

          <button class="btn btn-primary w-100" type="submit" [disabled]="form.invalid">
            <ng-container *ngIf="!isLoading; else processing">Create Batch</ng-container>
            <ng-template #processing>
              <span class="spinner-grow spinner-grow-sm me-2" aria-hidden="true"></span>
              Validating...
            </ng-template>
          </button>
        </form><br/>
        <button class="btn btn-info w-100" (click)="goBack()">Go back</button>
      </div>
    </div>
  </div>
</section>
<app-footer></app-footer>
  